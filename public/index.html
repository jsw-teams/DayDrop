<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>取回文件 · 1 天有效</title>
    <meta name="description" content="输入 6 位口令取回临时文件，上传与下载均需 Cloudflare Turnstile 验证。" />
    <link rel="stylesheet" href="/assets/app.css" />
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  </head>
  <body>
    <a class="skip" href="#main">跳到主要内容</a>
    <header>
      <a class="upload-link" href="/upload.html" aria-label="上传文件" accesskey="u" title="上传文件 (Alt+Shift+U)">
        <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3l4 4h-3v6h-2V7H8l4-4zm-7 14h14v2H5v-2z"/></svg>
        <span class="sr-only">上传</span>
      </a>
      <div class="brand" aria-hidden="true">临时文件</div>
    </header>

    <main id="main">
      <div class="wrap">
        <h1>取回文件（1 天有效）</h1>
        <section class="card">
          <form id="fetchForm" class="container" novalidate>
            <div>
              <label for="code">6 位口令</label>
              <input id="code" name="code" type="text" inputmode="numeric" pattern="[0-9]{6}" maxlength="6"
                     placeholder="例如 184263" aria-describedby="codeHelp" aria-required="true" autocomplete="one-time-code" />
              <div id="codeHelp" class="help">仅数字，输入后按回车即可。</div>
            </div>

            <div><div id="cf" aria-label="人机验证"></div></div>

            <div><button id="submitBtn" class="btn" type="submit">验证并下载</button></div>

            <div id="msg" class="msg" role="status" aria-live="polite"></div>
          </form>
        </section>
        <p class="footer">上传成功会返回 6 位口令。对方输入口令并通过验证即可下载；文件 24 小时后自动删除。</p>
      </div>
    </main>

    <script>
      // 随机壁纸（/?bg=off 关闭；或 /?bg=<url> 自定义）
      (function setRandomWallpaper(){
        try{
          const q = new URLSearchParams(location.search);
          const off = q.get('bg') === 'off';
          const custom = q.get('bg') && q.get('bg') !== 'off' ? q.get('bg') : null;
          if (off) return;
          const seed = Math.floor(Math.random()*1e6);
          const url = custom || `https://picsum.photos/1920/1080?random=${seed}`;
          document.documentElement.style.setProperty('--bg-image', `url("${url}")`);
        }catch(e){}
      })();

      const form = document.getElementById('fetchForm');
      const codeInput = document.getElementById('code');
      const msg = document.getElementById('msg');
      const submitBtn = document.getElementById('submitBtn');

      // 读取配置并渲染 Turnstile；未就绪时给出提示
      fetch('/api/config').then(r=>r.json()).then(cfg => {
        if (!cfg.ready) {
          msg.className = 'msg err';
          msg.textContent = '服务未完成配置：' + (cfg.missing || []).join(', ');
          return;
        }
        const paint = () => window.turnstile && window.turnstile.render('#cf', { sitekey: cfg.turnstileSiteKey });
        if (window.turnstile) paint(); else addEventListener('load', paint);
      }).catch(()=>{});

      // 输入即归一化
      window.setTimeout(()=>{ codeInput?.focus(); }, 0);
      codeInput.addEventListener('input', () => {
        const v = codeInput.value.replace(/\D/g, '').slice(0,6);
        if (v !== codeInput.value) codeInput.value = v;
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const norm = (codeInput.value || '').replace(/\D/g, '').slice(0,6);
        if (norm.length !== 6) {
          codeInput.setAttribute('aria-invalid','true');
          msg.textContent = '请输入 6 位数字口令';
          msg.className = 'msg err';
          codeInput.focus();
          return;
        } else codeInput.removeAttribute('aria-invalid');

        msg.textContent = '校验中…';
        msg.className = 'msg';
        submitBtn.disabled = true;
        form.setAttribute('aria-busy','true');

        try {
          const fd = new FormData(form);
          fd.set('code', norm); // 用规整后的值覆盖
          const res = await fetch('/api/fetch', { method: 'POST', body: fd });
          if (res.ok) {
            const disp = res.headers.get('Content-Disposition') || '';
            const m = disp.match(/filename\*=UTF-8''([^;]+)|filename="([^"]+)"/);
            const filename = decodeURIComponent(m?.[1] || m?.[2] || 'download');
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
            msg.textContent = `已开始下载：${filename}`;
            msg.className = 'msg ok';
            form.reset();
          } else {
            const data = await res.json().catch(()=>({}));
            throw new Error(data.error || `下载失败（HTTP ${res.status}）`);
          }
        } catch (err) {
          msg.textContent = err.message || '下载失败';
          msg.className = 'msg err';
        } finally {
          submitBtn.disabled = false;
          form.removeAttribute('aria-busy');
          if (window.turnstile) turnstile.reset();
        }
      });
    </script>
  </body>
</html>
