<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>上传文件 · 1 天有效</title>
    <meta name="description" content="上传临时文件，生成 6 位口令，24 小时后自动删除。" />
    <link rel="stylesheet" href="/assets/app.css" />
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  </head>
  <body>
    <a class="skip" href="#main">跳到主要内容</a>
    <header>
      <a class="home-link" href="/" aria-label="返回取件页" title="返回取件页">
        <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M10 4l-7 7 7 7v-4h8v-6h-8V4z"/></svg>
        <span class="sr-only">返回取件页</span>
      </a>
      <div class="brand" aria-hidden="true">临时文件</div>
    </header>

    <main id="main">
      <div class="wrap">
        <h1>临时文件上传（1 天有效）</h1>
        <section class="card">
          <form id="upForm" class="container" enctype="multipart/form-data" novalidate>
            <div class="drop" id="drop" role="region" aria-label="拖放文件到此处上传">
              <label for="file">选择文件</label>
              <input id="file" name="file" type="file" aria-describedby="fileHelp" required />
              <div id="fileHelp" class="help">总容量上限：5GB（全站共享）。也可将文件拖到此区域。</div>
            </div>

            <div>
              <label for="note">备注（可选）</label>
              <textarea id="note" name="note" rows="3" placeholder="给取件人看的说明…（最多 500 字）" maxlength="500"></textarea>
            </div>

            <div><div id="cf" aria-label="人机验证"></div></div>

            <div style="display:flex;gap:8px;align-items:center">
              <button id="submitBtn" class="btn" type="submit">上传</button>
              <button id="copyBtn" class="btn" type="button" style="display:none">复制口令</button>
              <span id="copyHint" class="help"></span>
            </div>

            <div id="msg" class="msg" role="status" aria-live="polite"></div>
          </form>
        </section>
        <p class="help" style="text-align:center">上传成功会返回 6 位口令。请在首页输入口令下载；文件 24 小时后自动删除。</p>
      </div>
    </main>

    <script>
      // 同步使用随机壁纸
      (function setRandomWallpaper(){
        const q = new URLSearchParams(location.search);
        const off = q.get('bg') === 'off';
        const custom = q.get('bg') && q.get('bg') !== 'off' ? q.get('bg') : null;
        if (!off) {
          const seed = Math.floor(Math.random()*1e6);
          const url = custom || `https://picsum.photos/1920/1080?random=${seed}`;
          document.documentElement.style.setProperty('--bg-image', `url("${url}")`);
        }
      })();

      const form = document.getElementById('upForm');
      const fileInput = document.getElementById('file');
      const drop = document.getElementById('drop');
      const msg = document.getElementById('msg');
      const submitBtn = document.getElementById('submitBtn');
      const copyBtn = document.getElementById('copyBtn');
      const copyHint = document.getElementById('copyHint');

      // Drag & Drop
      ['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.borderColor = '#60a5fa'; }));
      ['dragleave','drop'].forEach(ev => drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.borderColor = ''; }));
      drop.addEventListener('drop', (e)=>{ const f=e.dataTransfer?.files; if(f&&f.length){ fileInput.files=f; fileInput.dispatchEvent(new Event('change')); } });

      // Turnstile 渲染
      fetch('/api/config').then(r=>r.json()).then(cfg => {
        if (!cfg.ready) {
          msg.className = 'msg err';
          msg.textContent = '服务未完成配置：' + (cfg.missing || []).join(', ');
          return;
        }
        const paint = () => window.turnstile && window.turnstile.render('#cf', { sitekey: cfg.turnstileSiteKey });
        if (window.turnstile) paint(); else addEventListener('load', paint);
      }).catch(()=>{});

      copyBtn.addEventListener('click', async () => {
        const code = copyBtn.dataset.code || '';
        try { await navigator.clipboard.writeText(code); copyHint.textContent = '已复制'; }
        catch { copyHint.textContent = '复制失败，请手动选择'; }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = fileInput.files?.[0];
        if (!file) { msg.textContent = '请选择文件'; msg.className = 'msg err'; fileInput.focus(); return; }

        msg.textContent = '上传中…'; msg.className = 'msg';
        submitBtn.disabled = true; form.setAttribute('aria-busy','true'); drop.setAttribute('aria-busy','true');

        try {
          const fd = new FormData(form);
          const res = await fetch('/api/upload', { method: 'POST', body: fd });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || '上传失败');

          const until = new Date(data.expiresAt).toLocaleString();
          msg.innerHTML = `<span class="ok">上传成功！口令：<strong class="mono">${data.code}</strong>，有效期至 ${until}。<br/>返回<a href="/" aria-label="前往取回页">取回页</a>下载。</span>`;
          copyBtn.style.display='inline-flex'; copyBtn.dataset.code = data.code; copyHint.textContent='';
          form.reset();
        } catch (err) {
          msg.textContent = err.message || '上传失败'; msg.className = 'msg err';
        } finally {
          submitBtn.disabled = false; form.removeAttribute('aria-busy'); drop.removeAttribute('aria-busy');
          if (window.turnstile) turnstile.reset();
        }
      });
    </script>
  </body>
</html>
