<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>上传文件 · 1 天有效</title>
    <meta name="description" content="上传临时文件，生成 6 位口令，24 小时后自动删除。" />
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
      :root{
        --bg:#0b0c0f; --text:#f8fafc; --card:#111317; --muted:#cbd5e1; --border:#374151;
        --btn:#e5e7eb; --btn-ink:#0b0c0f; --bg-image:none; --bg-filter:brightness(0.45) saturate(1.15);
      }
      @media (prefers-color-scheme: light){
        :root{ --bg:#0b0f14; --text:#0b1220; --card:#ffffff; --muted:#475569; --border:#1f2937; --btn:#0f172a; --btn-ink:#ffffff; --bg-filter:brightness(0.75) saturate(1.1); }
      }

      html,body{height:100%}
      body{
        margin:0;background:var(--bg);color:var(--text);
        font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial; position:relative;
      }
      body::before{
        content:""; position:fixed; inset:0; z-index:-1;
        background: center/cover no-repeat var(--bg);
        background-image: var(--bg-image);
        filter: var(--bg-filter);
      }

      a{color:inherit;text-decoration:none}
      .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
      .skip{position:absolute;left:-9999px}
      .skip:focus{left:16px;top:12px;padding:8px 12px;background:var(--card);color:var(--text);border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,.4)}
      header{display:flex;align-items:center;gap:12px;padding:16px}
      .home-link{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:2px solid var(--border);border-radius:12px;background:var(--card)}
      .home-link:focus-visible{outline:3px solid currentColor;outline-offset:2px}

      main{display:grid;place-items:start center;padding:clamp(16px,3vw,32px)}
      .wrap{width:min(720px,100%)}
      h1{
        color:var(--text) !important;
        text-shadow:0 1px 0 rgba(0,0,0,.28);
        font-size:clamp(24px,3.5vw,34px);line-height:1.2;margin:0 0 14px;text-align:center;
      }
      .card{background:var(--card);border:2px solid var(--border);border-radius:18px;padding:clamp(18px,2.5vw,26px);box-shadow:0 2px 8px rgba(0,0,0,.22)}
      .container{display:grid;gap:16px}
      label{display:block;margin-bottom:6px;font-weight:700}
      input[type="file"], textarea{width:100%}
      textarea{padding:12px;border:2px solid var(--border);border-radius:12px;background:transparent;color:inherit}
      textarea:focus-visible{outline:3px solid currentColor;outline-offset:2px}
      .drop{border:2px dashed var(--border);border-radius:14px;padding:20px;text-align:center}
      .drop[aria-busy="true"]{opacity:.75}
      .help{color:var(--muted);font-size:14px}
      button{padding:12px 16px;border-radius:12px;border:0;background:var(--btn);color:var(--btn-ink);font-weight:800}
      button:focus-visible{outline:3px solid currentColor;outline-offset:2px}
      .msg{min-height:1.6em}
      .ok{color:#22c55e}.err{color:#ef4444}
      @media (forced-colors: active){.home-link,.card,textarea{border:1px solid CanvasText}}
    </style>
  </head>
  <body>
    <a class="skip" href="#main">跳到主要内容</a>
    <header>
      <a class="home-link" href="/" aria-label="返回取件页" title="返回取件页">
        <svg aria-hidden="true" focusable="false" width="20" height="20" viewBox="0 0 24 24" role="img"><path fill="currentColor" d="M10 4l-7 7 7 7v-4h8v-6h-8V4z"/></svg>
        <span class="sr-only">返回取件页</span>
      </a>
    </header>

    <main id="main">
      <div class="wrap">
        <h1>临时文件上传（1 天有效）</h1>
        <section class="card">
          <form id="upForm" class="container" enctype="multipart/form-data" novalidate>
            <div class="drop" id="drop" role="region" aria-label="拖放文件到此处上传">
              <label for="file">选择文件</label>
              <input id="file" name="file" type="file" aria-describedby="fileHelp" required />
              <div id="fileHelp" class="help">总容量上限：5GB（全站共享）。也可将文件拖到此区域。</div>
            </div>

            <div>
              <label for="note">备注（可选）</label>
              <textarea id="note" name="note" rows="3" placeholder="给取件人看的说明…（最多 500 字）" maxlength="500"></textarea>
            </div>

            <div><div id="cf" aria-label="人机验证"></div></div>

            <div><button id="submitBtn" type="submit">上传</button></div>

            <div id="msg" class="msg" role="status" aria-live="polite"></div>
          </form>
        </section>
        <p class="help" style="text-align:center">上传成功会返回 6 位口令。请在首页输入口令下载；文件 24 小时后自动删除。</p>
      </div>
    </main>

    <script>
      // 同步使用随机壁纸（同 index）
      (function setRandomWallpaper(){
        const q = new URLSearchParams(location.search);
        const off = q.get('bg') === 'off';
        const custom = q.get('bg') && q.get('bg') !== 'off' ? q.get('bg') : null;
        if (off) return;
        const seed = Math.floor(Math.random()*100000);
        const url = custom || `https://picsum.photos/1920/1080?random=${seed}`;
        document.documentElement.style.setProperty('--bg-image', `url("${url}")`);
      })();

      const form = document.getElementById('upForm');
      const fileInput = document.getElementById('file');
      const drop = document.getElementById('drop');
      const msg = document.getElementById('msg');
      const submitBtn = document.getElementById('submitBtn');

      ['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.borderColor = '#60a5fa'; }));
      ['dragleave','drop'].forEach(ev => drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.borderColor = ''; }));
      drop.addEventListener('drop', (e)=>{ const f=e.dataTransfer?.files; if(f&&f.length){ fileInput.files=f; fileInput.dispatchEvent(new Event('change')); } });

      // 渲染 Turnstile
      fetch('/api/config').then(r=>r.json()).then(cfg => {
        const paint = () => window.turnstile && window.turnstile.render('#cf', { sitekey: cfg.turnstileSiteKey });
        if (window.turnstile) paint(); else addEventListener('load', paint);
      }).catch(()=>{});

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = fileInput.files?.[0];
        if (!file) { msg.textContent = '请选择文件'; msg.className = 'msg err'; fileInput.focus(); return; }

        msg.textContent = '上传中…'; msg.className = 'msg';
        submitBtn.disabled = true; form.setAttribute('aria-busy','true'); drop.setAttribute('aria-busy','true');

        try {
          const fd = new FormData(form); // file/note/cf-turnstile-response
          const res = await fetch('/api/upload', { method: 'POST', body: fd });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || '上传失败');
          const until = new Date(data.expiresAt).toLocaleString();
          msg.innerHTML = `<span class="ok">上传成功！口令：<strong>${data.code}</strong>，有效期至 ${until}。<br/>返回<a href="/" aria-label="前往取回页">取回页</a>下载。</span>`;
          form.reset();
        } catch (err) {
          msg.textContent = err.message || '上传失败'; msg.className = 'msg err';
        } finally {
          submitBtn.disabled = false; form.removeAttribute('aria-busy'); drop.removeAttribute('aria-busy');
          if (window.turnstile) turnstile.reset();
        }
      });
    </script>
  </body>
</html>
